<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scientific Image Processing Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .drag-over { border-color: #3b82f6 !important; background-color: #eff6ff !important; }
        .file-item { transition: all 0.2s ease; }
        .file-item:hover { background-color: #f3f4f6; }
        .progress-bar { transition: width 0.3s ease; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .tab-inactive { color: #6b7280; }
        .tab-inactive:hover { color: #374151; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-slate-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 max-w-6xl">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl flex items-center justify-center">
                        <i class="fa fa-image text-white text-lg"></i>
                    </div>
                    <span class="font-bold text-xl text-gray-800">Scientific Image Assistant</span>
                </div>
                <div class="flex gap-1">
                    <button onclick="switchTab('convert')" id="tab-convert" class="px-5 py-2 font-medium transition-colors tab-active">
                        <i class="fa fa-exchange mr-2"></i>Format Convert
                    </button>
                    <button onclick="switchTab('collage')" id="tab-collage" class="px-5 py-2 font-medium transition-colors tab-inactive">
                        <i class="fa fa-th-large mr-2"></i>Image Collage
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Page 1: Format Conversion -->
        <div id="page-convert">
            <header class="text-center mb-10">
                <h1 class="text-4xl font-bold text-gray-900 mb-3">Image Format Converter</h1>
                <p class="text-gray-600 text-lg">Convert images between multiple formats with high quality</p>
            </header>

            <div class="bg-white rounded-3xl shadow-2xl p-8">
                <!-- Upload Area -->
                <div class="mb-8">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Upload Files</label>
                    <div id="drop-area" class="border-2 border-dashed border-gray-300 rounded-2xl p-12 text-center cursor-pointer transition-all duration-300 hover:border-blue-500 hover:bg-blue-50">
                        <input type="file" id="file-input" multiple accept=".pdf,.jpg,.jpeg,.png,.tif,.tiff,.svg" class="hidden">
                        <div class="w-20 h-20 bg-gradient-to-br from-blue-100 to-blue-200 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa fa-cloud-upload text-4xl text-blue-600"></i>
                        </div>
                        <p class="text-gray-700 font-medium mb-2">Drag & drop files here</p>
                        <p class="text-gray-500 text-sm mb-3">or click to browse</p>
                        <span class="text-xs text-gray-400 bg-gray-100 px-3 py-1 rounded-full">PDF, JPG, PNG, TIFF, SVG</span>
                    </div>
                </div>

                <!-- Files List -->
                <div id="files-list" class="mb-8 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-700">Uploaded Files</h3>
                        <button onclick="clearFiles()" class="text-sm text-red-500 hover:text-red-700">
                            <i class="fa fa-trash mr-1"></i> Clear All
                        </button>
                    </div>
                    <div id="files-container" class="space-y-3"></div>
                </div>

                <!-- Conversion Settings -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Convert To</label>
                        <select id="target-format" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                            <option value="jpg">JPEG</option>
                            <option value="png">PNG</option>
                            <option value="pdf">PDF</option>
                            <option value="tiff">TIFF</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">DPI (Quality)</label>
                        <div class="flex items-center gap-4">
                            <input type="range" id="dpi-slider" min="72" max="600" value="300" class="flex-1">
                            <input type="number" id="dpi-input" min="72" max="600" value="300" class="w-24 px-3 py-2 border border-gray-300 rounded-lg text-center">
                        </div>
                    </div>
                </div>

                <!-- Convert Button -->
                <button id="convert-btn" onclick="startConversion()" disabled class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-4 px-6 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl transition-all disabled:opacity-50">
                    <i class="fa fa-magic mr-2"></i> Convert Images
                </button>

                <!-- Progress -->
                <div id="progress-area" class="mt-8 hidden">
                    <div class="flex items-center justify-between mb-2">
                        <span id="progress-message" class="text-sm font-medium text-gray-700">Preparing...</span>
                        <span id="progress-percentage" class="text-sm font-bold text-blue-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="progress-fill" class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 progress-bar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Download Section -->
                <div id="download-section" class="mt-8 hidden">
                    <h3 class="font-semibold text-gray-700 mb-4">
                        <i class="fa fa-check-circle text-green-500 mr-2"></i> Conversion Complete!
                    </h3>
                    <div id="download-items" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- Page 2: Image Collage -->
        <div id="page-collage" class="hidden">
            <header class="text-center mb-10">
                <h1 class="text-4xl font-bold text-gray-900 mb-3">Image Collage</h1>
                <p class="text-gray-600 text-lg">Automatically convert and arrange images into a beautiful collage</p>
            </header>

            <div class="bg-white rounded-3xl shadow-2xl p-8">
                <!-- Upload Area for Collage -->
                <div class="mb-8">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Upload Images (Max 24)</label>
                    <div id="drop-area-collage" class="border-2 border-dashed border-gray-300 rounded-2xl p-12 text-center cursor-pointer transition-all duration-300 hover:border-purple-500 hover:bg-purple-50">
                        <input type="file" id="file-input-collage" multiple accept=".pdf,.jpg,.jpeg,.png,.tif,.tiff,.svg" class="hidden">
                        <div class="w-20 h-20 bg-gradient-to-br from-purple-100 to-purple-200 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa fa-images text-4xl text-purple-600"></i>
                        </div>
                        <p class="text-gray-700 font-medium mb-2">Drag & drop files here</p>
                        <p class="text-gray-500 text-sm mb-3">Max 24 images, PDF/PNG/JPG/SVG supported</p>
                        <span class="text-xs text-gray-400 bg-gray-100 px-3 py-1 rounded-full">Auto convert to 600 DPI JPEG</span>
                    </div>
                </div>

                <!-- Files List for Collage -->
                <div id="collage-files-list" class="mb-8 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-700">
                            <i class="fa fa-image text-purple-600 mr-2"></i>Selected Images (<span id="collage-count">0</span>/24)
                        </h3>
                        <button onclick="clearCollageFiles()" class="text-sm text-red-500 hover:text-red-700">
                            <i class="fa fa-trash mr-1"></i> Clear All
                        </button>
                    </div>
                    <div id="collage-files-container" class="space-y-3"></div>
                </div>

                <!-- Collage Layout Settings -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Columns</label>
                        <select id="collage-cols" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            <option value="2">2 Columns</option>
                            <option value="3" selected>3 Columns</option>
                            <option value="4">4 Columns</option>
                            <option value="6">6 Columns</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Output Size</label>
                        <select id="output-size" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            <option value="1200">Small (1200px)</option>
                            <option value="1800" selected>Medium (1800px)</option>
                            <option value="2400">Large (2400px)</option>
                        </select>
                    </div>
                </div>

                <!-- Generate Button -->
                <button id="generate-btn" onclick="generateCollage()" disabled class="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white py-4 px-6 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl transition-all disabled:opacity-50">
                        <i class="fa fa-magic mr-2"></i> Generate Collage
                    </button>

                <!-- Progress -->
                <div id="collage-progress-area" class="mt-8 hidden">
                    <div class="flex items-center justify-between mb-2">
                        <span id="collage-progress-message" class="text-sm font-medium text-gray-700">Initializing...</span>
                        <span id="collage-progress-percentage" class="text-sm font-bold text-purple-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="collage-progress-fill" class="bg-gradient-to-r from-purple-500 to-purple-600 h-3 progress-bar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Collage Result -->
                <div id="collage-result" class="mt-8 hidden">
                    <h3 class="font-semibold text-gray-700 mb-4">
                        <i class="fa fa-check-circle text-green-500 mr-2"></i>Collage Generated!
                    </h3>
                    <div id="collage-preview" class="border rounded-xl overflow-hidden mb-4"></div>
                    <button onclick="downloadCollage()" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-3 px-6 rounded-xl font-semibold">
                        <i class="fa fa-download mr-2"></i> Download Collage
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ Tab Switching ============
        function switchTab(tab) {
            document.getElementById('page-convert').classList.add('hidden');
            document.getElementById('page-collage').classList.add('hidden');
            document.getElementById('tab-convert').className = 'px-5 py-2 font-medium transition-colors tab-inactive';
            document.getElementById('tab-collage').className = 'px-5 py-2 font-medium transition-colors tab-inactive';
            
            document.getElementById('page-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).className = 'px-5 py-2 font-medium transition-colors tab-active';
        }

        // ============ Page 1: Format Conversion ============
        let uploadedFiles = [];
        
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, e => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(e => dropArea.addEventListener(e, () => dropArea.classList.add('drag-over')));
        ['dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, () => dropArea.classList.remove('drag-over')));
        dropArea.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
        dropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', e => handleFiles(e.target.files));

        function handleFiles(files) {
            const valid = ['.pdf','.jpg','.jpeg','.png','.tif','.tiff','.svg'];
            Array.from(files).forEach(f => {
                const ext = '.' + f.name.split('.').pop().toLowerCase();
                if (valid.includes(ext)) uploadedFiles.push(f);
            });
            updateFilesList();
        }

        function updateFilesList() {
            const container = document.getElementById('files-container');
            container.innerHTML = '';
            document.getElementById('files-list').classList.toggle('hidden', uploadedFiles.length === 0);
            document.getElementById('convert-btn').disabled = uploadedFiles.length === 0;
            
            uploadedFiles.forEach((f, i) => {
                const div = document.createElement('div');
                div.className = 'file-item bg-gray-50 p-4 rounded-xl flex justify-between items-center';
                div.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
                            <i class="fa fa-file-image-o"></i>
                        </div>
                        <div class="ml-3">
                            <p class="font-medium">${f.name.length > 30 ? f.name.substring(0,30)+'...' : f.name}</p>
                            <p class="text-xs text-gray-500">${formatSize(f.size)}</p>
                        </div>
                    </div>
                    <button onclick="removeFile(${i})" class="text-red-500 hover:text-red-700 p-2"><i class="fa fa-times"></i></button>
                `;
                container.appendChild(div);
            });
        }

        function removeFile(i) { uploadedFiles.splice(i, 1); updateFilesList(); }
        function clearFiles() { uploadedFiles = []; updateFilesList(); }
        function formatSize(b) { if (!b) return '0 B'; const s = ['B','KB','MB','GB']; const i = Math.floor(Math.log(b)/Math.log(1024)); return (b/Math.pow(1024,i)).toFixed(1) + ' ' + s[i]; }

        document.getElementById('dpi-slider').addEventListener('input', e => document.getElementById('dpi-input').value = e.target.value);
        document.getElementById('dpi-input').addEventListener('input', e => {
            let v = parseInt(e.target.value); if (v < 72) v = 72; if (v > 600) v = 600;
            e.target.value = v; document.getElementById('dpi-slider').value = v;
        });

        async function startConversion() {
            if (uploadedFiles.length === 0) return;
            const btn = document.getElementById('convert-btn');
            btn.disabled = true;
            document.getElementById('progress-area').classList.remove('hidden');
            document.getElementById('download-section').classList.add('hidden');
            
            const targetFormat = document.getElementById('target-format').value;
            const dpi = parseInt(document.getElementById('dpi-input').value);
            const results = [];

            for (let i = 0; i < uploadedFiles.length; i++) {
                const progress = Math.round((i / uploadedFiles.length) * 100);
                document.getElementById('progress-fill').style.width = progress + '%';
                document.getElementById('progress-percentage').textContent = progress + '%';
                document.getElementById('progress-message').textContent = `Converting: ${uploadedFiles[i].name}`;
                
                try {
                    const blob = await convertToJpeg(uploadedFiles[i], dpi);
                    results.push({ name: uploadedFiles[i].name.replace(/\.[^/.]+$/,'') + '.jpg', blob });
                } catch (e) {
                    console.error(e);
                }
            }

            document.getElementById('progress-fill').style.width = '100%';
            document.getElementById('progress-percentage').textContent = '100%';
            showDownloadResults(results);
            btn.disabled = false;
        }

        async function convertToJpeg(file, dpi) {
            const ext = '.' + file.name.split('.').pop().toLowerCase();
            if (ext === '.pdf') {
                return await convertPdfToJpeg(file, dpi);
            } else if (ext === '.svg') {
                return await convertSvgToJpeg(file, dpi);
            } else {
                return await convertImageToJpeg(file, dpi);
            }
        }

        async function convertPdfToJpeg(file, dpi) {
            const arr = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arr }).promise;
            const page = await pdf.getPage(1);
            const scale = dpi / 72;
            const viewport = page.getViewport({ scale });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            const ctx = canvas.getContext('2d');
            await page.render({ canvasContext: ctx, viewport }).promise;
            return canvasToJpeg(canvas, dpi);
        }

        async function convertSvgToJpeg(file, dpi) {
            const text = await file.text();
            const img = new Image();
            const svgBlob = new Blob([text], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(svgBlob);
            return new Promise((resolve, reject) => {
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width || 800;
                    canvas.height = img.height || 600;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    URL.revokeObjectURL(url);
                    resolve(canvasToJpeg(canvas, dpi));
                };
                img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('SVG load failed')); };
                img.src = url;
            });
        }

        async function convertImageToJpeg(file, dpi) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const url = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    URL.revokeObjectURL(url);
                    resolve(canvasToJpeg(canvas, dpi));
                };
                img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('Image load failed')); };
                img.src = url;
            });
        }

        function canvasToJpeg(canvas, dpi) {
            return new Promise((resolve) => {
                // Simple approach - convert canvas directly to JPEG
                canvas.toBlob((blob) => {
                    if (blob) {
                        resolve(blob);
                    } else {
                        // Fallback
                        const dataURL = canvas.toDataURL('image/jpeg', 0.95);
                        const byteString = atob(dataURL.split(',')[1]);
                        const mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0];
                        const ab = new ArrayBuffer(byteString.length);
                        const ia = new Uint8Array(ab);
                        for (let i = 0; i < byteString.length; i++) {
                            ia[i] = byteString.charCodeAt(i);
                        }
                        resolve(new Blob([ab], { type: mimeString }));
                    }
                }, 'image/jpeg', 0.95);
            });
        }

        function showDownloadResults(results) {
            const container = document.getElementById('download-items');
            container.innerHTML = '';
            document.getElementById('download-section').classList.remove('hidden');
            
            results.forEach(r => {
                const url = URL.createObjectURL(r.blob);
                const div = document.createElement('div');
                div.className = 'bg-green-50 p-4 rounded-xl flex justify-between items-center';
                div.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-green-200 rounded-lg flex items-center justify-center text-green-600">
                            <i class="fa fa-file-image-o"></i>
                        </div>
                        <div class="ml-3">
                            <p class="font-medium">${r.name}</p>
                            <p class="text-xs text-green-600">Converted successfully</p>
                        </div>
                    </div>
                    <a href="${url}" download="${r.name}" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                        <i class="fa fa-download"></i> Download
                    </a>
                `;
                container.appendChild(div);
            });
        }

        // ============ Page 2: Image Collage ============
        let collageFiles = [];
        
        const dropAreaCollage = document.getElementById('drop-area-collage');
        const fileInputCollage = document.getElementById('file-input-collage');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropAreaCollage.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(e => dropAreaCollage.addEventListener(e, () => dropAreaCollage.classList.add('drag-over')));
        ['dragleave', 'drop'].forEach(e => dropAreaCollage.addEventListener(e, () => dropAreaCollage.classList.remove('drag-over')));
        dropAreaCollage.addEventListener('drop', e => handleCollageFiles(e.dataTransfer.files));
        dropAreaCollage.addEventListener('click', () => fileInputCollage.click());
        fileInputCollage.addEventListener('change', e => handleCollageFiles(e.target.files));

        function handleCollageFiles(files) {
            const valid = ['.pdf','.jpg','.jpeg','.png','.tif','.tiff','.svg'];
            Array.from(files).forEach(f => {
                if (collageFiles.length >= 24) return;
                const ext = '.' + f.name.split('.').pop().toLowerCase();
                if (valid.includes(ext)) collageFiles.push(f);
            });
            updateCollageFilesList();
        }

        function updateCollageFilesList() {
            const container = document.getElementById('collage-files-container');
            container.innerHTML = '';
            document.getElementById('collage-files-list').classList.toggle('hidden', collageFiles.length === 0);
            document.getElementById('collage-count').textContent = collageFiles.length;
            document.getElementById('generate-btn').disabled = collageFiles.length === 0;
            
            const letters = 'abcdefghijklmnopqrstuvwx';
            collageFiles.forEach((f, i) => {
                const div = document.createElement('div');
                div.className = 'file-item bg-purple-50 p-4 rounded-xl flex justify-between items-center';
                div.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-purple-200 rounded-full flex items-center justify-center text-purple-700 font-bold text-sm">
                            ${letters[i]}
                        </div>
                        <div class="ml-3">
                            <p class="font-medium">${f.name.length > 35 ? f.name.substring(0,35)+'...' : f.name}</p>
                        </div>
                    </div>
                    <button onclick="removeCollageFile(${i})" class="text-red-500 hover:text-red-700 p-2"><i class="fa fa-times"></i></button>
                `;
                container.appendChild(div);
            });
        }

        function removeCollageFile(i) { collageFiles.splice(i, 1); updateCollageFilesList(); }
        function clearCollageFiles() { collageFiles = []; updateCollageFilesList(); }

        document.querySelectorAll('input[name="arrange-method"]').forEach(r => {
            r.addEventListener('change', e => {
                document.getElementById('manual-input-section').classList.toggle('hidden', e.target.value !== 'manual');
            });
        });

        async function generateCollage() {
            if (collageFiles.length === 0) return;
            
            const btn = document.getElementById('generate-btn');
            btn.disabled = true;
            document.getElementById('collage-progress-area').classList.remove('hidden');
            document.getElementById('collage-result').classList.add('hidden');
            
            try {
                // Step 1: Convert all to 600 DPI JPEG
                updateCollageProgress(10, 'Converting images to 600 DPI JPEG...');
                const images = [];
                const letters = 'abcdefghijklmnopqrstuvwx';
                
                for (let i = 0; i < collageFiles.length; i++) {
                    const progress = 10 + Math.round((i / collageFiles.length) * 40);
                    updateCollageProgress(progress, `Converting: ${collageFiles[i].name}`);
                    const blob = await convertToJpeg(collageFiles[i], 600);
                    images.push({ blob, letter: letters[i], index: i });
                }

                // Step 2: AI Analysis for smart arrangement
                updateCollageProgress(50, 'AI analyzing images for smart arrangement...');
                const analyzedImages = await analyzeImagesWithAI(images);
                
                // Sort images based on AI analysis
                analyzedImages.sort((a, b) => a.order - b.order);
                
                // Update letters after sorting
                for (let i = 0; i < analyzedImages.length; i++) {
                    analyzedImages[i].letter = letters[i];
                }

                // Step 3: Create collage
                updateCollageProgress(80, 'Generating collage layout...');
                const cols = parseInt(document.getElementById('collage-cols').value);
                const outputSize = parseInt(document.getElementById('output-size').value);
                
                const collageBlob = await createCollage(analyzedImages, cols, outputSize);

                // Step 4: Show result
                updateCollageProgress(100, 'Complete!');
                showCollageResult(collageBlob);
            } catch (e) {
                alert('Error: ' + e.message);
                console.error(e);
            }
            
            btn.disabled = false;
        }

        function updateCollageProgress(percent, message) {
            document.getElementById('collage-progress-fill').style.width = percent + '%';
            document.getElementById('collage-progress-percentage').textContent = percent + '%';
            document.getElementById('collage-progress-message').textContent = message;
        }

        async function analyzeImagesWithAI(images) {
            const results = [];
            const totalImages = images.length;
            
            for (let i = 0; i < totalImages; i++) {
                const progress = 50 + Math.round((i / totalImages) * 30);
                updateCollageProgress(progress, `AI analyzing image ${i+1}/${totalImages}...`);
                
                try {
                    const blob = images[i].blob;
                    const base64 = await blobToBase64(blob);
                    
                    const prompt = `Analyze this scientific image and tell me: 1) What type of figure is it (e.g., bar chart, line plot, microscopy photo, flowchart)? 2) What does it show? Respond in this exact JSON format: {"order": N, "description": "X"} where N is the logical sequence number from 1 to ${totalImages}. For example, if this is the first figure in a paper, order should be 1.`;
                    
                    console.log('Calling AI for image', i+1);
                    
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: base64, prompt: prompt })
                    });
                    
                    console.log('AI response status:', response.status);
                    
                    if (!response.ok) throw new Error('API failed: ' + response.status);
                    
                    const data = await response.json();
                    console.log('AI response data:', data);
                    
                    // Try to parse JSON from description
                    let parsed = null;
                    try {
                        if (data.description) {
                            // Try to extract JSON from response
                            const jsonMatch = data.description.match(/\{[^}]+\}/);
                            if (jsonMatch) {
                                parsed = JSON.parse(jsonMatch[0]);
                            }
                        }
                    } catch (e) {
                        console.error('JSON parse error:', e);
                    }
                    
                    if (parsed && parsed.order) {
                        results.push({
                            ...images[i],
                            order: parsed.order,
                            description: parsed.description || ''
                        });
                    } else {
                        // If no valid JSON, use the description as-is with original order
                        console.log('Using fallback for image', i+1);
                        results.push({
                            ...images[i],
                            order: i + 1,
                            description: data.description ? data.description.substring(0, 50) : 'image'
                        });
                    }
                } catch (e) {
                    console.error('Error analyzing image:', e);
                    results.push({
                        ...images[i],
                        order: i + 1,
                        description: images[i].letter
                    });
                }
            }
            
            console.log('Final analyzed results:', results);
            return results;
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        async function createCollage(images, cols, outputSize) {
            const rows = Math.ceil(images.length / cols);
            const cellWidth = Math.floor(outputSize / cols);
            const cellHeight = Math.floor(cellWidth * 0.75);
            
            const canvas = document.createElement('canvas');
            canvas.width = cols * cellWidth;
            canvas.height = rows * cellHeight;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            for (let i = 0; i < images.length; i++) {
                const col = i % cols;
                const row = Math.floor(i / cols);
                const x = col * cellWidth;
                const y = row * cellHeight;
                
                try {
                    if (!images[i].blob) continue;
                    const img = await loadImage(images[i].blob);
                    const scale = Math.min(cellWidth / img.width, cellHeight / img.height);
                    const drawWidth = img.width * scale;
                    const drawHeight = img.height * scale;
                    const drawX = x + (cellWidth - drawWidth) / 2;
                    const drawY = y + (cellHeight - drawHeight) / 2;
                    
                    ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                    
                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 28px Arial';
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'top';
                    ctx.fillText(images[i].letter, x + 10, y + 10);
                } catch (e) {
                    console.error('Error drawing image', i, e);
                }
            }
            
            return new Promise(resolve => canvas.toBlob(b => resolve(b), 'image/jpeg', 0.95));
        }

        function loadImage(blob) {
            return new Promise((resolve, reject) => {
                if (!blob || !(blob instanceof Blob)) {
                    reject(new Error('Invalid blob'));
                    return;
                }
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = URL.createObjectURL(blob);
            });
        }

        let currentCollageBlob = null;
        
        function showCollageResult(blob) {
            currentCollageBlob = blob;
            const url = URL.createObjectURL(blob);
            const container = document.getElementById('collage-preview');
            container.innerHTML = `<img src="${url}" class="w-full h-auto" style="max-height: 600px; object-fit: contain;">`;
            document.getElementById('collage-result').classList.remove('hidden');
        }

        function downloadCollage() {
            if (!currentCollageBlob) return;
            const url = URL.createObjectURL(currentCollageBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'collage_' + Date.now() + '.jpg';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
